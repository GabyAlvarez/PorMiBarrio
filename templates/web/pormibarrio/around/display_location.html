[%

    rss_alt   = loc('RSS feed');
    rss_title = loc('RSS feed of recent local problems');

    rss_url
        = pc
        ? c.uri_for( "/rss/pc", pc )
        : c.uri_for( "/rss/l/$short_latitude,$short_longitude" );

    email_url = c.uri_for(
        '/alert/list',
        {
            lat  => short_latitude,
            lon  => short_longitude,
            feed => "local:$short_latitude:$short_longitude",
        }
    );

    url_skip = c.uri_for(
        '/report/new',
        {
            pc         => pc
            latitude   => short_latitude,
            longitude  => short_longitude,
            skipped    => 1,
        }
    );

    PROCESS "maps/${map.type}.html";

    SET rss = [ loc('Recent local problems, FixMyStreet'), rss_url ] IF c.cobrand.moniker != 'emptyhomes';
    INCLUDE 'header.html',
        title  => loc('Viewing a location')
        bodyclass => 'mappage',
        robots => 'noindex,nofollow';

    allow_creation = !c.cobrand.only_authed_can_create || (c.user && c.user.from_body);
%]
<div id="s-categories" class="s-categories-maximized">
  <div id="s-categories-toggle">
    <div id="toggle-image" class="toggle-down" onclick="toggleCategories();">
    </div>
  </div>
</div>
[% IF allow_creation %]
<form action="[% c.uri_for('/report/new') %]" method="post" name="mapForm" id="mapForm" enctype="multipart/form-data" class="validate">
    [% IF c.req.params.map_override %]
        <input type="hidden" name="map_override" value="[% c.req.params.map_override | html %]">
    [% END %]
    <input type="hidden" name="pc" value="[% pc | html %]">

    <input type="hidden" name="latitude" id="fixmystreet.latitude" value="[% short_latitude | html %]">
    <input type="hidden" name="longitude" id="fixmystreet.longitude" value="[% short_longitude | html %]">
[% END %]

    [% map_html %]

    <p id='sub_map_links'>
        [% IF c.req.params.no_pins %]
            <a id='hide_pins_link' rel='nofollow' href='[% c.uri_with( { no_pins => 0 } ) %]'>[% loc('Show pins') %]</a>
        [% ELSE %]
            <a id='hide_pins_link' rel='nofollow' href='[% c.uri_with( { no_pins => 1 } ) %]'>[% loc('Hide pins') %]</a>
        [% END %]
    </p>

    </div>



    [% IF list %]
        <div id="side">
    [% ELSE %]
        <div id="side" style="display:none">
    [% END %]
        [% IF allow_creation %]
            [% TRY %][% INCLUDE 'around/extra_text.html' %][% CATCH file %][% END %]
        [% END %]

      [% IF c.cobrand.moniker != 'emptyhomes' %]
        [% INCLUDE 'around/_updates.html' %]

        <section class="full-width">
            [% INCLUDE "around/tabbed_lists.html" %]
        </section>
      [% END %]
    </div>

    [% IF allow_creation %]
        [% IF list %]
            <div id="side-form" style="display:none">
        [% ELSE %]
            <div id="side-form">
        [% END %]
    [% INCLUDE "report/new/fill_in_details_form.html"
        js = 1,
        report.used_map = 1
        report.name = c.user.name
    %]
    </div>
    [% END %]

[% IF allow_creation %]
</form>
[% END %]
[% INCLUDE 'footer.html' %]
<script type="text/javascript">
  function getCategoryGroups(){
    var latitude = "-34.906557";
    var longitude = "-56.199769";
    if(fixmystreet){
      latitude = fixmystreet.latitude;
      longitude = fixmystreet.longitude;
    }

    $.getJSON( "/report/new/ajax?latitude="+latitude+"&longitude="+longitude+"&format=json", function( data ) {
      var categories = data.categories;
      $.each( categories, function( key, val ) {
        if(key!=-2){
          var name="";
          var icon = "./i/category/";
          var color = "";
          $.each( val, function( key2, val2 ) {
            if(key2=="name"){
              name = val2;
            }
            if(key2=="icon"){
              icon = icon + val2 + ".png";
            }
            if(key2=="color"){
              color = val2;
            }
          });
          var group_id = key;
          addCategoryFilter(name,group_id,icon, color);
        }
      });
    })
      .done(function() {
      })
      .fail(function() {
        //console.log( "error" );
      })
      .always(function() {
        //console.log( "complete" );
      });
  }

  function addCategoryFilter(name,group_id,icon,color){
      /*var html = "<div class='category_filter' id='category_filter_" + group_id + "' onclick='selectCategoryGroup(\""+group_id+"\")'>";
      html = html + "<img class='filter_icon' src='."+icon+"'/>";
      html = html + "<h3>" + name + "</h3>";
      html = html + "</div>";*/
      var html = "<div style='background-color: "+color+"' class='category_filter' id='category_filter_" + group_id + "' onclick='selectCategoryGroup(\""+group_id+"\")'>";
      //html = html + "<img class='filter_icon' src='."+icon+"'/>";
      html = html + "<h4>" + name + "</h4>";
      html = html + "</div>";
      $("#s-categories").append(html);
  }

  function selectCategoryGroup(id){
    if(!selectedCategories){
      selectedCategories = new Array();
    }
    var filter = document.getElementById("category_filter_"+id);
    if(filter.style.backgroundColor == "transparent" || filter.style.backgroundColor == ""){
      filter.style.backgroundColor = "#000000";
      selectedCategories.push(id);
    }else{
      filter.style.backgroundColor = "transparent";
      /*var index = selectedCategories.indexOf(id);
      if (index > -1) {
          selectedCategories = selectedCategories.splice(index, 1);
      }*/
      var newList = new Array();
      selectedCategories.forEach(function(element,index,array){
        if(element!=id){
          newList.push(element);
        }
      });
      selectedCategories = newList;
    }
    var strCats = selectedCategories.join(',');
    if(!strCats){
      strCats = "all";
    }
    fixmystreet.map.layers.forEach(function(element,index,array){
      if(element.options.protocol){
        element.options.protocol.params.categories = strCats;
      }
    });
    fixmystreet.markers.refresh({force: true});
  }

  function toggleCategories(){
    var actualClass = $("#s-categories").attr("class");
    if(actualClass=="s-categories-maximized"){
      $("#s-categories").removeClass().addClass("s-categories-minimized");
      $("#toggle-image").removeClass().addClass("toggle-up");
    }else{
      $("#s-categories").removeClass().addClass("s-categories-maximized");
      $("#toggle-image").removeClass().addClass("toggle-down");
    }

  }

  getCategoryGroups();
</script>
